name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  packages: write

env:
  GO_VERSION: '1.23.3'
  DOCKER_IMAGE: 'share-screen'
  REGISTRY: 'ghcr.io'

jobs:
  # Environment Dependencies Check
  check-env:
    name: 🔍 Check Environment Dependencies
    runs-on: ubuntu-latest
    outputs:
      should-deploy-prod: ${{ steps.check-secrets.outputs.should-deploy-prod }}

    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4

    - name: 🔍 Check required secrets and environment
      id: check-secrets
      run: |
        echo "🔍 Checking production environment dependencies..."

        # Initialize deployment flag
        SHOULD_DEPLOY_PROD="false"

        echo "📋 Branch: ${{ github.ref_name }}"
        echo "📋 Event: ${{ github.event_name }}"

        # Check if we should attempt production deployment
        if [[ "${{ github.ref }}" == "refs/heads/main" && "${{ github.event_name }}" == "push" ]]; then
          echo "🎯 Production deployment conditions met, checking secrets..."

          # Check production secrets
          MISSING_PROD_SECRETS=""
          if [ -z "${{ secrets.SSH_USER }}" ]; then MISSING_PROD_SECRETS="$MISSING_PROD_SECRETS SSH_USER"; fi
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then MISSING_PROD_SECRETS="$MISSING_PROD_SECRETS SSH_PRIVATE_KEY"; fi
          if [ -z "${{ secrets.SERVER_HOST }}" ]; then MISSING_PROD_SECRETS="$MISSING_PROD_SECRETS SERVER_HOST"; fi
          if [ -z "${{ secrets.DEPLOY_PATH }}" ]; then MISSING_PROD_SECRETS="$MISSING_PROD_SECRETS DEPLOY_PATH"; fi

          if [ -n "$MISSING_PROD_SECRETS" ]; then
            echo "❌ Production deployment DISABLED - Missing required secrets:$MISSING_PROD_SECRETS"
            echo "📖 Please configure these secrets in GitHub Settings → Secrets and variables → Actions"
          else
            echo "✅ Production deployment ENABLED - All required secrets configured"
            SHOULD_DEPLOY_PROD="true"
          fi
        else
          echo "⏭️ Production deployment skipped (not main branch push)"
        fi

        # Production environment status report
        echo ""
        echo "🌍 Production Environment Check:"
        if [ -z "${{ secrets.SSH_USER }}" ] || [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ] || [ -z "${{ secrets.SERVER_HOST }}" ] || [ -z "${{ secrets.DEPLOY_PATH }}" ]; then
          echo "  ❌ Missing required secrets"
        else
          echo "  ✅ All required secrets configured"
        fi
        echo "  - PROD_HTTPS_PORT: ${{ secrets.PROD_HTTPS_PORT && '✅ Set' || '❌ Missing' }}"
        echo "  - PROD_STUN_SERVER: ${{ secrets.PROD_STUN_SERVER && '✅ Set' || '❌ Missing' }}"
        echo "  - PROD_TOKEN_EXPIRY: ${{ secrets.PROD_TOKEN_EXPIRY && '✅ Set' || '❌ Missing' }}"
        echo "  - PROD_TLS_CERT_FILE: ${{ secrets.PROD_TLS_CERT_FILE && '✅ Set' || '❌ Missing' }}"
        echo "  - PROD_TLS_KEY_FILE: ${{ secrets.PROD_TLS_KEY_FILE && '✅ Set' || '❌ Missing' }}"

        # Set output
        echo "should-deploy-prod=$SHOULD_DEPLOY_PROD" >> $GITHUB_OUTPUT

        echo ""
        echo "🎯 Deployment Summary:"
        echo "  Production: $SHOULD_DEPLOY_PROD"

        # Check if ALL production secrets are complete (HTTPS ONLY)
        if [ -z "${{ secrets.SSH_USER }}" ] || [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ] || [ -z "${{ secrets.SERVER_HOST }}" ] || [ -z "${{ secrets.DEPLOY_PATH }}" ] || \
           [ -z "${{ secrets.PROD_HTTPS_PORT }}" ] || [ -z "${{ secrets.PROD_STUN_SERVER }}" ] || [ -z "${{ secrets.PROD_TOKEN_EXPIRY }}" ] || \
           [ -z "${{ secrets.PROD_TLS_CERT_FILE }}" ] || [ -z "${{ secrets.PROD_TLS_KEY_FILE }}" ]; then
          echo ""
          echo "❌ CRITICAL: Production environment missing required secrets!"
          echo "📋 Required connection secrets: SSH_USER, SSH_PRIVATE_KEY, SERVER_HOST, DEPLOY_PATH"
          echo "📋 Required HTTPS secrets: PROD_HTTPS_PORT, PROD_TLS_CERT_FILE, PROD_TLS_KEY_FILE"
          echo "📋 Required application secrets: PROD_STUN_SERVER, PROD_TOKEN_EXPIRY"
          echo ""
          echo "💥 ENVIRONMENT CHECK FAILED"
          echo "📖 Please configure ALL required secrets in GitHub Settings → Secrets and variables → Actions"
          echo "🚫 CI/CD pipeline stopped - production environment incomplete"
          exit 1
        fi

        echo ""
        echo "✅ ENVIRONMENT CHECK PASSED"
        echo "🎯 Production environment has all required secrets configured"

  # Test and Quality Assurance
  test:
    name: 🧪 Test & Quality Check
    runs-on: ubuntu-latest
    needs: check-env

    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4

    - name: 🐹 Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: 📦 Cache Go modules
      uses: actions/cache@v4
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: 📥 Download dependencies
      run: go mod download

    - name: 🔍 Verify dependencies
      run: go mod verify

    - name: 🧹 Format check
      run: |
        if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
          echo "❌ Code is not properly formatted:"
          gofmt -s -l .
          exit 1
        fi
        echo "✅ Code is properly formatted"

    - name: 🔎 Vet check
      run: go vet ./...

    - name: 🧪 Run tests with coverage
      run: |
        go test -v -race -coverprofile=coverage.out -covermode=atomic ./...
        go tool cover -html=coverage.out -o coverage.html

    - name: 📊 Display test coverage
      run: go tool cover -func=coverage.out

    - name: 📤 Upload coverage reports
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: |
          coverage.out
          coverage.html

    - name: 🏗️ Test build
      run: go build -v ./...

  # Security Scanning
  security:
    name: 🔒 Security & Quality Scan
    runs-on: ubuntu-latest
    needs: [check-env, test]

    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4

    - name: 🐹 Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: 📦 Download dependencies
      run: go mod download

    - name: 🔍 Run Go Security Scanner
      run: |
        echo "🔍 Running security and quality checks..."

        # Run go vet for potential issues
        echo "📋 Running go vet..."
        go vet ./...

        # Check for common security patterns
        echo "🔒 Checking for security patterns..."

        # Check for hardcoded credentials (basic check)
        if grep -r -i --include="*.go" "password.*=.*[\"'].*[\"']\|secret.*=.*[\"'].*[\"']\|api.*key.*=.*[\"'].*[\"']" . | grep -v "_test.go" | grep -v "mock" | grep -v "example" | grep -v "flag\|env\|config"; then
          echo "⚠️ Potential hardcoded credentials found"
          exit 1
        fi

        # Check for SQL injection patterns
        if grep -r --include="*.go" "fmt.Sprintf.*%.*SELECT\|fmt.Sprintf.*%.*INSERT\|fmt.Sprintf.*%.*UPDATE" .; then
          echo "⚠️ Potential SQL injection patterns found"
          exit 1
        fi

        # Check for unsafe use of crypto/md5 or crypto/sha1
        if grep -r --include="*.go" "crypto/md5\|crypto/sha1" . | grep -v "_test.go"; then
          echo "⚠️ Unsafe cryptographic functions found (md5/sha1)"
          exit 1
        fi

        echo "✅ Basic security checks passed"

    - name: 🏗️ Advanced Build Check
      run: |
        echo "🏗️ Running advanced build checks..."

        # Build with race detector
        go build -race ./...

        # Check for unused dependencies
        go mod tidy
        if ! git diff --quiet go.mod; then
          echo "⚠️ go.mod not tidy"
          git diff go.mod
          exit 1
        fi

        # Check go.sum only if it exists
        if [ -f go.sum ] && ! git diff --quiet go.sum; then
          echo "⚠️ go.sum not tidy"
          git diff go.sum
          exit 1
        fi

        echo "✅ Advanced build checks passed"

    - name: 📊 Security scan summary
      run: |
        echo "🛡️ Security scan completed successfully!"
        echo "✅ Go vet checks passed"
        echo "✅ Basic security patterns checked"
        echo "✅ No hardcoded credentials detected"
        echo "✅ No unsafe crypto usage detected"
        echo "✅ Dependencies are tidy"

  # Build Docker Image
  build:
    name: 🐳 Build Docker Image
    runs-on: ubuntu-latest
    needs: [check-env, test, security]

    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4

    - name: 🐳 Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: 🔐 Log in to Container Registry
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: 📝 Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/rhyanz46/${{ env.DOCKER_IMAGE }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}

    - name: 🏗️ Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: 🧪 Test Docker image
      run: |
        docker run --rm ${{ env.REGISTRY }}/rhyanz46/${{ env.DOCKER_IMAGE }}:latest --help

  # Deploy to Server (only if secrets configured)
  deploy:
    name: 🚀 Deploy to Server
    runs-on: ubuntu-latest
    needs: [check-env, test, security, build]
    if: needs.check-env.outputs.should-deploy-prod == 'true'
    environment: production

    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4

    - name: 🔐 Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: 🌐 Add server to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

    - name: 📂 Create deployment directory
      run: |
        ssh ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} "
          mkdir -p ${{ secrets.DEPLOY_PATH }}
        "

    - name: 📤 Copy files to server
      run: |
        rsync -avz --delete \
          --exclude='.git' \
          --exclude='coverage.*' \
          --exclude='*.test' \
          --exclude='bin/' \
          ./ ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }}:${{ secrets.DEPLOY_PATH }}/


    - name: 🚀 Deploy with Docker Compose
      run: |
        ssh ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} "
          cd ${{ secrets.DEPLOY_PATH }}

          echo '🔍 Current docker-compose.yml content:'
          head -10 docker-compose.yml

          echo ''
          echo '🛑 Stopping existing containers...'
          docker compose down || true

          echo ''
          echo '🔧 Setting environment variables...'
          export PORT=${{ secrets.PROD_HTTPS_PORT }}
          export HTTPS_PORT=${{ secrets.PROD_HTTPS_PORT }}
          export ENABLE_HTTPS=true
          export STUN_SERVER='${{ secrets.PROD_STUN_SERVER }}'
          export TOKEN_EXPIRY='${{ secrets.PROD_TOKEN_EXPIRY }}'
          export TLS_CERT_FILE='${{ secrets.PROD_TLS_CERT_FILE }}'
          export TLS_KEY_FILE='${{ secrets.PROD_TLS_KEY_FILE }}'

          echo 'Environment variables set:'
          echo 'HTTPS_PORT=' \$HTTPS_PORT
          echo 'ENABLE_HTTPS=' \$ENABLE_HTTPS
          echo 'TLS_CERT_FILE=' \$TLS_CERT_FILE
          echo 'TLS_KEY_FILE=' \$TLS_KEY_FILE

          echo ''
          echo '🏗️ Building and starting containers...'
          docker compose up -d --build

          echo ''
          echo '📋 Container status:'
          docker compose ps

          echo ''
          echo '📄 Container logs:'
          docker compose logs

          # Wait for containers to be ready
          sleep 15
        "

    - name: 🩺 Health check
      run: |
        ssh ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} "
          cd ${{ secrets.DEPLOY_PATH }}

          # Set HTTPS port from environment
          HEALTH_CHECK_PORT=${{ secrets.PROD_HTTPS_PORT }}

          # Check if containers are running
          if docker compose ps | grep -q 'Up'; then
            echo '✅ Docker containers are running'
          else
            echo '❌ Docker containers failed to start'
            docker compose logs
            exit 1
          fi

          # Check if port is listening
          if ss -tlnp | grep :\$HEALTH_CHECK_PORT; then
            echo '✅ Application is listening on port '\$HEALTH_CHECK_PORT
          else
            echo '❌ Application is not listening on expected port '\$HEALTH_CHECK_PORT
            exit 1
          fi

          # Test HTTPS endpoint
          if curl -f -s -k https://localhost:\$HEALTH_CHECK_PORT/ > /dev/null 2>&1; then
            echo '✅ HTTPS endpoint is responding'
          else
            echo '⚠️ HTTPS endpoint test failed (might be expected if app requires specific paths)'
          fi
        "

    - name: 📊 Deployment Summary
      run: |
        echo "🎉 Deployment completed successfully!"
        echo "📅 Deployed at: $(date)"
        echo "🌐 Server: ${{ secrets.SERVER_HOST }}"
        echo "📂 Path: ${{ secrets.DEPLOY_PATH }}"
        echo "🐳 Deployment: Docker Compose"
        echo "🔒 HTTPS: https://${{ secrets.SERVER_HOST }}:${{ secrets.PROD_HTTPS_PORT }}"

  # Notification
  notify:
    name: 📢 Notify Deployment
    runs-on: ubuntu-latest
    needs: [check-env, deploy]
    if: always() && needs.check-env.outputs.should-deploy-prod == 'true'

    steps:
    - name: 📢 Send notification
      uses: 8398a7/action-slack@v3
      if: env.SLACK_WEBHOOK != ''
      with:
        status: ${{ needs.deploy.result }}
        channel: '#deployments'
        text: |
          🚀 Share Screen deployment ${{ needs.deploy.result }}
          📅 Branch: ${{ github.ref_name }}
          👤 Author: ${{ github.actor }}
          📝 Commit: ${{ github.event.head_commit.message }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}